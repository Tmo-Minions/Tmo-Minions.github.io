<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔法工艺九宫格点灯解密工具</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 15px;
            background-color: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
            font-size: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin: 20px 0;
        }
        .cell {
            width: 80px;
            height: 80px;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background-color: #e0e0e0;
            transition: all 0.2s;
        }
        .cell.lit {
            background-color: #ffeb3b;
            color: #333;
        }
        .cell.unlit {
            background-color: #424242;
            color: #fff;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }
        button {
            padding: 10px 15px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background-color: #2196F3;
            color: white;
        }
        button:active {
            background-color: #1976D2;
        }
        #resetBtn {
            background-color: #f44336;
        }
        #resetBtn:active {
            background-color: #d32f2f;
        }
        .result {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .step {
            font-size: 18px;
            font-weight: bold;
            color: #2196F3;
            margin: 10px 0;
            text-align: center;
        }
        .note {
            font-size: 14px;
            color: #666;
            margin-top: 10px;
            text-align: center;
        }
        .status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>魔法工艺九宫格点灯解密工具</h1>
    
    <div class="grid" id="grid">
        <div class="cell unlit" data-index="0">1</div>
        <div class="cell unlit" data-index="1">2</div>
        <div class="cell unlit" data-index="2">3</div>
        <div class="cell unlit" data-index="3">4</div>
        <div class="cell unlit" data-index="4">5</div>
        <div class="cell unlit" data-index="5">6</div>
        <div class="cell unlit" data-index="6">7</div>
        <div class="cell unlit" data-index="7">8</div>
        <div class="cell unlit" data-index="8">9</div>
    </div>
    
    <div class="controls">
        <button id="solveBtn">生成解密步骤</button>
        <button id="resetBtn">重置</button>
    </div>
    
    <div class="result">
        <div id="status" class="status">点击格子设置初始状态</div>
        <div id="steps" class="step"></div>
        <div id="note" class="note"></div>
    </div>

    <script>
        // 网格状态，0表示灭，1表示亮
        let gridState = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        
        // 获取DOM元素
        const grid = document.getElementById('grid');
        const cells = document.querySelectorAll('.cell');
        const solveBtn = document.getElementById('solveBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statusDiv = document.getElementById('status');
        const stepsDiv = document.getElementById('steps');
        const noteDiv = document.getElementById('note');
        
        // 点击格子事件
        cells.forEach(cell => {
            cell.addEventListener('click', () => {
                const index = parseInt(cell.getAttribute('data-index'));
                // 切换状态
                gridState[index] = gridState[index] === 0 ? 1 : 0;
                // 更新UI
                updateGridUI();
                statusDiv.textContent = `当前状态: ${gridState.map((s, i) => s ? (i+1) : '').filter(x => x).join(',') || '全灭'}`;
                stepsDiv.textContent = '';
                noteDiv.textContent = '';
            });
        });
        
        // 更新网格UI
        function updateGridUI() {
            cells.forEach((cell, index) => {
                if (gridState[index] === 1) {
                    cell.classList.add('lit');
                    cell.classList.remove('unlit');
                } else {
                    cell.classList.add('unlit');
                    cell.classList.remove('lit');
                }
            });
        }
        
        // 重置按钮
        resetBtn.addEventListener('click', () => {
            gridState = [0, 0, 0, 0, 0, 0, 0, 0, 0];
            updateGridUI();
            statusDiv.textContent = '点击格子设置初始状态';
            stepsDiv.textContent = '';
            noteDiv.textContent = '';
        });
        
        // 解密按钮
        solveBtn.addEventListener('click', () => {
            const solution = findSolution();
            if (solution) {
                statusDiv.textContent = '解密步骤:';
                stepsDiv.textContent = solution.join('-');
                noteDiv.textContent = '按照顺序点击这些格子即可全部点亮';
            } else {
                statusDiv.textContent = '无解或已全部点亮';
                stepsDiv.textContent = '';
                noteDiv.textContent = '请尝试其他状态';
            }
        });
        
        // 查找解密步骤
        function findSolution() {
            // 如果已经全部点亮，不需要操作
            if (gridState.every(state => state === 1)) {
                return [];
            }
            
            // 特殊情况：只剩一个不亮时的解法
            const unlitIndices = gridState.map((state, index) => state === 0 ? index : -1).filter(index => index !== -1);
            
            if (unlitIndices.length === 1) {
                const unlitIndex = unlitIndices[0] + 1; // 转换为1-9的编号
                const specialCases = {
                    1: [1, 3, 6, 7, 8],
                    2: [5, 7, 8, 9],
                    3: [1, 3, 4, 8, 9],
                    4: [3, 5, 6, 9],
                    5: [2, 4, 5, 6, 8],
                    6: [1, 4, 5, 7],
                    7: [1, 2, 6, 7, 9],
                    8: [1, 2, 3, 5],
                    9: [2, 3, 4, 7, 9]
                };
                return specialCases[unlitIndex];
            }
            
            // 通用解法：使用高斯消元法求解
            // 构建9x9的关联矩阵
            const A = [];
            for (let i = 0; i < 9; i++) {
                A[i] = [];
                for (let j = 0; j < 9; j++) {
                    // 如果i和j相同，或者i和j相邻，则A[i][j] = 1
                    const row = Math.floor(i / 3);
                    const col = i % 3;
                    const jRow = Math.floor(j / 3);
                    const jCol = j % 3;
                    if (i === j || 
                        (Math.abs(row - jRow) === 1 && col === jCol) || 
                        (Math.abs(col - jCol) === 1 && row === jRow)) {
                        A[i][j] = 1;
                    } else {
                        A[i][j] = 0;
                    }
                }
            }
            
            // 目标状态：全部点亮，即全1向量
            const b = gridState.map(s => 1 - s); // 我们需要将当前状态转换为目标状态需要的操作
            
            // 高斯消元法求解 Ax = b (mod 2)
            const solution = gaussElimination(A, b);
            
            if (solution) {
                // 将解转换为格子编号（1-9）
                return solution.map((val, index) => val === 1 ? index + 1 : -1).filter(x => x !== -1);
            }
            
            return null;
        }
        
        // 高斯消元法求解线性方程组 (mod 2)
        function gaussElimination(A, b) {
            const n = A.length;
            // 构建增广矩阵
            const augmented = A.map((row, i) => [...row, b[i]]);
            
            // 前向消元
            for (let col = 0; col < n; col++) {
                // 寻找主元
                let pivot = -1;
                for (let row = col; row < n; row++) {
                    if (augmented[row][col] === 1) {
                        pivot = row;
                        break;
                    }
                }
                
                if (pivot === -1) continue; // 无主元，跳过
                
                // 交换行
                if (pivot !== col) {
                    [augmented[col], augmented[pivot]] = [augmented[pivot], augmented[col]];
                }
                
                // 消去其他行的该列
                for (let row = 0; row < n; row++) {
                    if (row !== col && augmented[row][col] === 1) {
                        for (let k = col; k <= n; k++) {
                            augmented[row][k] ^= augmented[col][k];
                        }
                    }
                }
            }
            
            // 回代求解
            const solution = new Array(n).fill(0);
            for (let i = 0; i < n; i++) {
                // 找到主元列
                let pivotCol = -1;
                for (let j = 0; j < n; j++) {
                    if (augmented[i][j] === 1) {
                        pivotCol = j;
                        break;
                    }
                }
                if (pivotCol !== -1) {
                    solution[pivotCol] = augmented[i][n];
                }
            }
            
            // 验证解是否正确
            for (let i = 0; i < n; i++) {
                let sum = 0;
                for (let j = 0; j < n; j++) {
                    sum += A[i][j] * solution[j];
                }
                if (sum % 2 !== b[i]) {
                    return null; // 无解
                }
            }
            
            return solution;
        }
    </script>
</body>
</html>
