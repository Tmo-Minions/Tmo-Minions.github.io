<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>文字修仙挂机游戏</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@400;700&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Serif SC', serif;
            background-color: #0a0a1a;
            color: #e0d8b0;
            line-height: 1.6;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(28, 58, 103, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(58, 28, 103, 0.1) 0%, transparent 20%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }
        
        header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid #3a2c1f;
            margin-bottom: 20px;
        }
        
        h1 {
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 3.5rem;
            color: #e6b422;
            text-shadow: 0 0 10px rgba(230, 180, 34, 0.5);
            letter-spacing: 5px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a89a7a;
        }
        
        .main-game {
            background-color: rgba(20, 15, 35, 0.8);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 1px solid #3a2c1f;
        }
        
        .sidebar {
            background-color: rgba(20, 15, 35, 0.8);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 1px solid #3a2c1f;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        h2 {
            color: #d4af37;
            font-size: 1.8rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid #3a2c1f;
            font-family: 'Ma Shan Zheng', cursive;
        }
        
        h3 {
            color: #b8a86d;
            font-size: 1.4rem;
            margin-bottom: 10px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-item {
            background-color: rgba(40, 30, 60, 0.7);
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #d4af37;
        }
        
        .stat-name {
            font-size: 1.1rem;
            color: #a89a7a;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.8rem;
            color: #e6b422;
            font-weight: bold;
        }
        
        .button {
            background: linear-gradient(to bottom, #3a2c1f, #1a120b);
            color: #e0d8b0;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-family: 'Noto Serif SC', serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #5d4a2a;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .button:hover {
            background: linear-gradient(to bottom, #4a3c2f, #2a220b);
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3);
        }
        
        .button:active {
            transform: translateY(1px);
        }
        
        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .button-primary {
            background: linear-gradient(to bottom, #5d3a1a, #3a1f0b);
            border-color: #b87333;
        }
        
        .button-primary:hover {
            background: linear-gradient(to bottom, #6d4a2a, #4a2f1b);
        }
        
        .progress-container {
            background-color: rgba(30, 20, 40, 0.7);
            height: 24px;
            border-radius: 12px;
            margin: 15px 0;
            overflow: hidden;
            border: 1px solid #3a2c1f;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, #2a5c3d, #4caf7a);
            border-radius: 12px;
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .progress-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
        }
        
        .log {
            background-color: rgba(10, 5, 20, 0.9);
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #3a2c1f;
            font-family: monospace;
            font-size: 1rem;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px dashed rgba(90, 80, 60, 0.3);
        }
        
        .log-time {
            color: #7a6a4a;
            font-size: 0.9rem;
        }
        
        .log-content {
            color: #e0d8b0;
        }
        
        .event-good {
            color: #4caf7a;
        }
        
        .event-bad {
            color: #d32f2f;
        }
        
        .event-neutral {
            color: #64b5f6;
        }
        
        .cultivation-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .cultivation-speed {
            color: #4caf7a;
            font-weight: bold;
        }
        
        .upgrade-item {
            background-color: rgba(40, 30, 60, 0.7);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #7b5c9e;
        }
        
        .upgrade-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .upgrade-cost {
            color: #e6b422;
            font-weight: bold;
        }
        
        .upgrade-desc {
            color: #a89a7a;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }
        
        .toggle-switch {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }
        
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #3a2c1f;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: #e0d8b0;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4caf7a;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .footer {
            grid-column: 1 / -1;
            text-align: center;
            padding: 20px;
            color: #7a6a4a;
            font-size: 0.9rem;
            border-top: 1px solid #3a2c1f;
            margin-top: 20px;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 600px) {
            .stats {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>文字修仙</h1>
            <div class="subtitle">静心修炼，突破境界，证道长生</div>
        </header>
        
        <main class="main-game">
            <div class="section">
                <h2>修炼状态</h2>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-name">当前境界</div>
                        <div class="stat-value" id="realm">炼气期一层</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">修为</div>
                        <div class="stat-value" id="cultivation">0/100</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">灵石</div>
                        <div class="stat-value" id="spiritStones">100</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">修炼速度</div>
                        <div class="stat-value" id="cultivationSpeed">1/秒</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">灵石收入</div>
                        <div class="stat-value" id="incomeSpeed">0/秒</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-name">修炼时间</div>
                        <div class="stat-value" id="cultivationTime">0秒</div>
                    </div>
                </div>
                
                <div class="cultivation-info">
                    <div>修为进度</div>
                    <div>速度: <span class="cultivation-speed" id="speedDisplay">1/秒</span></div>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="cultivationBar">
                        <div class="progress-text" id="cultivationText">0%</div>
                    </div>
                </div>
                
                <div class="toggle-switch">
                    <span>自动修炼</span>
                    <label class="switch">
                        <input type="checkbox" id="autoCultivateToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <div class="section">
                <h2>功法修炼</h2>
                <div id="cultivationActions">
                    <button class="button button-primary" id="cultivateBtn">开始修炼</button>
                    <button class="button" id="breakthroughBtn" disabled>突破境界</button>
                    <button class="button" id="meditateBtn" disabled>闭关冥想</button>
                    <button class="button" id="absorbSpiritBtn" disabled>吸收灵气</button>
                </div>
            </div>
            
            <div class="section">
                <h2>修炼日志</h2>
                <div class="log" id="gameLog">
                    <div class="log-entry">
                        <div class="log-time">[初始]</div>
                        <div class="log-content">你来到修仙世界，开始你的修炼之旅。当前境界：炼气期一层。</div>
                    </div>
                    <div class="log-entry">
                        <div class="log-time">[提示]</div>
                        <div class="log-content">自动修炼已开启，你将自动获得修为。尝试突破境界以获得更强的能力。</div>
                    </div>
                </div>
            </div>
        </main>
        
        <aside class="sidebar">
            <div class="section">
                <h2>功法升级</h2>
                <div id="upgradesList">
                    <!-- 功法升级项将由JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="section">
                <h2>丹药炼制</h2>
                <div id="alchemyList">
                    <!-- 丹药项将由JavaScript动态生成 -->
                </div>
            </div>
            
            <div class="section">
                <h2>洞府建设</h2>
                <div id="manorList">
                    <!-- 洞府升级项将由JavaScript动态生成 -->
                </div>
            </div>
        </aside>
        
        <footer class="footer">
            <p>文字修仙挂机游戏 | 静心修炼，证道长生 | 游戏数据自动保存在浏览器本地</p>
        </footer>
    </div>

    <script>
        // 游戏主对象
        const game = {
            // 游戏状态
            cultivation: 0,
            spiritStones: 100,
            realmIndex: 0,
            cultivationSpeed: 1,
            incomeSpeed: 0,
            totalCultivationTime: 0,
            autoCultivate: true,
            
            // 游戏数据
            realms: [
                { name: "炼气期一层", required: 100, speedMultiplier: 1 },
                { name: "炼气期二层", required: 250, speedMultiplier: 1.2 },
                { name: "炼气期三层", required: 500, speedMultiplier: 1.5 },
                { name: "炼气期四层", required: 1000, speedMultiplier: 1.8 },
                { name: "炼气期五层", required: 2000, speedMultiplier: 2.2 },
                { name: "炼气期六层", required: 4000, speedMultiplier: 2.7 },
                { name: "炼气期七层", required: 8000, speedMultiplier: 3.3 },
                { name: "炼气期八层", required: 16000, speedMultiplier: 4.0 },
                { name: "炼气期九层", required: 32000, speedMultiplier: 5.0 },
                { name: "炼气期十层", required: 64000, speedMultiplier: 6.0 },
                { name: "筑基期", required: 128000, speedMultiplier: 8.0 },
                { name: "金丹期", required: 512000, speedMultiplier: 12.0 },
                { name: "元婴期", required: 2048000, speedMultiplier: 18.0 },
                { name: "化神期", required: 8192000, speedMultiplier: 25.0 },
                { name: "炼虚期", required: 32768000, speedMultiplier: 35.0 },
                { name: "合体期", required: 131072000, speedMultiplier: 50.0 },
                { name: "大乘期", required: 524288000, speedMultiplier: 80.0 },
                { name: "渡劫期", required: 2097152000, speedMultiplier: 120.0 }
            ],
            
            upgrades: [
                { id: "breathing", name: "基础吐纳法", desc: "提升10%修炼速度", cost: 50, multiplier: 1.1, level: 0, maxLevel: 10 },
                { id: "meridian", name: "经脉拓展", desc: "提升15%修炼速度", cost: 200, multiplier: 1.15, level: 0, maxLevel: 5 },
                { id: "spiritSense", name: "灵识增强", desc: "提升20%修炼速度", cost: 1000, multiplier: 1.2, level: 0, maxLevel: 5 },
                { id: "spiritGathering", name: "聚灵阵", desc: "提升灵石收入速度", cost: 500, income: 0.5, level: 0, maxLevel: 10 },
                { id: "spiritField", name: "灵田", desc: "提升灵石收入速度", cost: 2000, income: 2, level: 0, maxLevel: 5 }
            ],
            
            alchemy: [
                { id: "qiPill", name: "益气丹", desc: "立即获得100修为", cost: 20, cultivation: 100 },
                { id: "spiritPill", name: "聚灵丹", desc: "立即获得500修为", cost: 80, cultivation: 500 },
                { id: "breakthroughPill", name: "破境丹", desc: "增加10%突破成功率", cost: 200, effect: "breakthrough" },
                { id: "speedPill", name: "疾风丹", desc: "10秒内修炼速度翻倍", cost: 150, effect: "speed" }
            ],
            
            manor: [
                { id: "simpleHouse", name: "简易洞府", desc: "提升5%修炼速度", cost: 300, multiplier: 1.05, level: 0, maxLevel: 1 },
                { id: "spiritHouse", name: "灵气洞府", desc: "提升10%修炼速度", cost: 1500, multiplier: 1.1, level: 0, maxLevel: 1 },
                { id: "spiritMine", name: "灵石矿", desc: "提升灵石收入速度", cost: 1000, income: 1, level: 0, maxLevel: 5 }
            ],
            
            // 游戏变量
            speedBoostEnd: 0,
            logs: [],
            
            // 初始化游戏
            init() {
                this.loadGame();
                this.render();
                this.setupEventListeners();
                
                // 开始游戏循环
                setInterval(() => this.gameLoop(), 100);
                setInterval(() => this.randomEvent(), 10000);
                
                this.log("游戏初始化完成，开始你的修仙之旅吧！", "neutral");
            },
            
            // 游戏主循环
            gameLoop() {
                const now = Date.now();
                
                // 自动修炼
                if (this.autoCultivate) {
                    // 计算修炼速度加成
                    let currentSpeed = this.cultivationSpeed;
                    if (this.speedBoostEnd > now) {
                        currentSpeed *= 2;
                    }
                    
                    // 应用升级加成
                    let speedMultiplier = 1;
                    this.upgrades.forEach(upgrade => {
                        if (upgrade.level > 0 && upgrade.multiplier) {
                            speedMultiplier *= Math.pow(upgrade.multiplier, upgrade.level);
                        }
                    });
                    
                    // 应用洞府加成
                    this.manor.forEach(item => {
                        if (item.level > 0 && item.multiplier) {
                            speedMultiplier *= Math.pow(item.multiplier, item.level);
                        }
                    });
                    
                    currentSpeed *= speedMultiplier;
                    
                    // 增加修为
                    this.cultivation += currentSpeed / 10;
                    this.totalCultivationTime += 0.1;
                    
                    // 增加灵石收入
                    let incomeMultiplier = 1;
                    this.upgrades.forEach(upgrade => {
                        if (upgrade.level > 0 && upgrade.income) {
                            incomeMultiplier += upgrade.income * upgrade.level;
                        }
                    });
                    
                    this.manor.forEach(item => {
                        if (item.level > 0 && item.income) {
                            incomeMultiplier += item.income * item.level;
                        }
                    });
                    
                    this.spiritStones += incomeMultiplier / 10;
                }
                
                // 检查突破条件
                const breakthroughBtn = document.getElementById('breakthroughBtn');
                if (this.cultivation >= this.getCurrentRealm().required) {
                    breakthroughBtn.disabled = false;
                } else {
                    breakthroughBtn.disabled = true;
                }
                
                // 更新显示
                this.render();
            },
            
            // 渲染游戏状态
            render() {
                // 更新数值显示
                document.getElementById('cultivation').textContent = 
                    `${Math.floor(this.cultivation)}/${this.getCurrentRealm().required}`;
                document.getElementById('spiritStones').textContent = Math.floor(this.spiritStones);
                document.getElementById('realm').textContent = this.getCurrentRealm().name;
                
                // 计算并显示修炼速度
                let currentSpeed = this.cultivationSpeed;
                if (this.speedBoostEnd > Date.now()) {
                    currentSpeed *= 2;
                }
                
                // 应用升级加成
                let speedMultiplier = 1;
                this.upgrades.forEach(upgrade => {
                    if (upgrade.level > 0 && upgrade.multiplier) {
                        speedMultiplier *= Math.pow(upgrade.multiplier, upgrade.level);
                    }
                });
                
                // 应用洞府加成
                this.manor.forEach(item => {
                    if (item.level > 0 && item.multiplier) {
                        speedMultiplier *= Math.pow(item.multiplier, item.level);
                    }
                });
                
                currentSpeed *= speedMultiplier;
                
                document.getElementById('cultivationSpeed').textContent = `${currentSpeed.toFixed(1)}/秒`;
                document.getElementById('speedDisplay').textContent = `${currentSpeed.toFixed(1)}/秒`;
                
                // 计算并显示灵石收入速度
                let incomeMultiplier = 0;
                this.upgrades.forEach(upgrade => {
                    if (upgrade.level > 0 && upgrade.income) {
                        incomeMultiplier += upgrade.income * upgrade.level;
                    }
                });
                
                this.manor.forEach(item => {
                    if (item.level > 0 && item.income) {
                        incomeMultiplier += item.income * item.level;
                    }
                });
                
                document.getElementById('incomeSpeed').textContent = `${incomeMultiplier.toFixed(1)}/秒`;
                document.getElementById('cultivationTime').textContent = `${Math.floor(this.totalCultivationTime)}秒`;
                
                // 更新修为进度条
                const currentRealm = this.getCurrentRealm();
                const progress = (this.cultivation / currentRealm.required) * 100;
                const progressBar = document.getElementById('cultivationBar');
                const progressText = document.getElementById('cultivationText');
                
                progressBar.style.width = `${Math.min(progress, 100)}%`;
                progressText.textContent = `${Math.min(progress, 100).toFixed(1)}%`;
                
                // 渲染升级项
                this.renderUpgrades();
                
                // 渲染丹药项
                this.renderAlchemy();
                
                // 渲染洞府项
                this.renderManor();
                
                // 保存游戏
                this.saveGame();
            },
            
            // 渲染升级项
            renderUpgrades() {
                const upgradesList = document.getElementById('upgradesList');
                upgradesList.innerHTML = '';
                
                this.upgrades.forEach(upgrade => {
                    const canAfford = this.spiritStones >= upgrade.cost * Math.pow(1.5, upgrade.level);
                    const isMaxLevel = upgrade.level >= upgrade.maxLevel;
                    
                    const upgradeElement = document.createElement('div');
                    upgradeElement.className = 'upgrade-item';
                    upgradeElement.innerHTML = `
                        <div class="upgrade-header">
                            <h3>${upgrade.name} Lv.${upgrade.level}/${upgrade.maxLevel}</h3>
                            <div class="upgrade-cost">${Math.floor(upgrade.cost * Math.pow(1.5, upgrade.level))}灵石</div>
                        </div>
                        <div class="upgrade-desc">${upgrade.desc}</div>
                        <button class="button ${canAfford && !isMaxLevel ? 'button-primary' : ''}" 
                                ${!canAfford || isMaxLevel ? 'disabled' : ''}
                                onclick="game.buyUpgrade('${upgrade.id}')">
                            ${isMaxLevel ? '已满级' : '购买'}
                        </button>
                    `;
                    
                    upgradesList.appendChild(upgradeElement);
                });
            },
            
            // 渲染丹药项
            renderAlchemy() {
                const alchemyList = document.getElementById('alchemyList');
                alchemyList.innerHTML = '';
                
                this.alchemy.forEach(pill => {
                    const canAfford = this.spiritStones >= pill.cost;
                    
                    const pillElement = document.createElement('div');
                    pillElement.className = 'upgrade-item';
                    pillElement.innerHTML = `
                        <div class="upgrade-header">
                            <h3>${pill.name}</h3>
                            <div class="upgrade-cost">${pill.cost}灵石</div>
                        </div>
                        <div class="upgrade-desc">${pill.desc}</div>
                        <button class="button ${canAfford ? 'button-primary' : ''}" 
                                ${!canAfford ? 'disabled' : ''}
                                onclick="game.buyPill('${pill.id}')">
                            炼制
                        </button>
                    `;
                    
                    alchemyList.appendChild(pillElement);
                });
            },
            
            // 渲染洞府项
            renderManor() {
                const manorList = document.getElementById('manorList');
                manorList.innerHTML = '';
                
                this.manor.forEach(item => {
                    const canAfford = this.spiritStones >= item.cost * Math.pow(2, item.level);
                    const isMaxLevel = item.level >= item.maxLevel;
                    
                    const itemElement = document.createElement('div');
                    itemElement.className = 'upgrade-item';
                    itemElement.innerHTML = `
                        <div class="upgrade-header">
                            <h3>${item.name} ${item.level > 0 ? `Lv.${item.level}/${item.maxLevel}` : ''}</h3>
                            <div class="upgrade-cost">${Math.floor(item.cost * Math.pow(2, item.level))}灵石</div>
                        </div>
                        <div class="upgrade-desc">${item.desc}</div>
                        <button class="button ${canAfford && !isMaxLevel ? 'button-primary' : ''}" 
                                ${!canAfford || isMaxLevel ? 'disabled' : ''}
                                onclick="game.buyManor('${item.id}')">
                            ${isMaxLevel ? '已满级' : '建造'}
                        </button>
                    `;
                    
                    manorList.appendChild(itemElement);
                });
            },
            
            // 购买升级
            buyUpgrade(upgradeId) {
                const upgrade = this.upgrades.find(u => u.id === upgradeId);
                const cost = upgrade.cost * Math.pow(1.5, upgrade.level);
                
                if (this.spiritStones >= cost && upgrade.level < upgrade.maxLevel) {
                    this.spiritStones -= cost;
                    upgrade.level++;
                    
                    this.log(`成功升级${upgrade.name}到${upgrade.level}级！`, "good");
                    this.render();
                }
            },
            
            // 购买丹药
            buyPill(pillId) {
                const pill = this.alchemy.find(p => p.id === pillId);
                
                if (this.spiritStones >= pill.cost) {
                    this.spiritStones -= pill.cost;
                    
                    if (pill.cultivation) {
                        this.cultivation += pill.cultivation;
                        this.log(`服用${pill.name}，获得${pill.cultivation}修为！`, "good");
                    } else if (pill.effect === "speed") {
                        this.speedBoostEnd = Date.now() + 10000; // 10秒速度提升
                        this.log(`服用${pill.name}，10秒内修炼速度翻倍！`, "good");
                    } else if (pill.effect === "breakthrough") {
                        // 突破丹效果在突破时应用
                        this.log(`服用${pill.name}，下次突破成功率提升！`, "good");
                    }
                    
                    this.render();
                }
            },
            
            // 购买洞府
            buyManor(itemId) {
                const item = this.manor.find(m => m.id === itemId);
                const cost = item.cost * Math.pow(2, item.level);
                
                if (this.spiritStones >= cost && item.level < item.maxLevel) {
                    this.spiritStones -= cost;
                    item.level++;
                    
                    this.log(`成功建造/升级${item.name}到${item.level}级！`, "good");
                    this.render();
                }
            },
            
            // 获取当前境界
            getCurrentRealm() {
                return this.realms[this.realmIndex];
            },
            
            // 突破境界
            breakthrough() {
                const currentRealm = this.getCurrentRealm();
                
                if (this.cultivation >= currentRealm.required) {
                    this.cultivation -= currentRealm.required;
                    this.realmIndex++;
                    
                    const newRealm = this.getCurrentRealm();
                    this.log(`恭喜！你成功突破到${newRealm.name}！`, "good");
                    
                    // 每次突破略微提升基础修炼速度
                    this.cultivationSpeed *= 1.05;
                    
                    this.render();
                }
            },
            
            // 随机事件
            randomEvent() {
                const events = [
                    {
                        text: "你在修炼时心有所感，对功法有了新的领悟。",
                        type: "good",
                        action: () => {
                            this.cultivation += 50;
                        }
                    },
                    {
                        text: "发现一处小型灵石矿脉，获得一些灵石。",
                        type: "good",
                        action: () => {
                            const stones = Math.floor(Math.random() * 50) + 20;
                            this.spiritStones += stones;
                        }
                    },
                    {
                        text: "修炼时遇到瓶颈，修为略有倒退。",
                        type: "bad",
                        action: () => {
                            this.cultivation = Math.max(0, this.cultivation - 30);
                        }
                    },
                    {
                        text: "遭遇妖兽袭击，消耗灵石布置防御阵法。",
                        type: "bad",
                        action: () => {
                            const loss = Math.floor(Math.random() * 30) + 10;
                            this.spiritStones = Math.max(0, this.spiritStones - loss);
                        }
                    },
                    {
                        text: "偶遇前辈指点，修炼速度暂时提升。",
                        type: "neutral",
                        action: () => {
                            this.speedBoostEnd = Date.now() + 15000; // 15秒速度提升
                        }
                    }
                ];
                
                // 10%几率触发事件
                if (Math.random() < 0.1) {
                    const event = events[Math.floor(Math.random() * events.length)];
                    event.action();
                    this.log(`[事件] ${event.text}`, event.type);
                }
            },
            
            // 添加日志
            log(message, type = "neutral") {
                const now = new Date();
                const timeString = `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
                
                const logEntry = document.createElement('div');
                logEntry.className = 'log-entry';
                logEntry.innerHTML = `
                    <div class="log-time">${timeString}</div>
                    <div class="log-content ${type === 'good' ? 'event-good' : type === 'bad' ? 'event-bad' : 'event-neutral'}">${message}</div>
                `;
                
                const gameLog = document.getElementById('gameLog');
                gameLog.appendChild(logEntry);
                gameLog.scrollTop = gameLog.scrollHeight;
                
                // 限制日志数量
                const entries = gameLog.querySelectorAll('.log-entry');
                if (entries.length > 50) {
                    gameLog.removeChild(entries[0]);
                }
            },
            
            // 保存游戏
            saveGame() {
                const saveData = {
                    cultivation: this.cultivation,
                    spiritStones: this.spiritStones,
                    realmIndex: this.realmIndex,
                    cultivationSpeed: this.cultivationSpeed,
                    totalCultivationTime: this.totalCultivationTime,
                    autoCultivate: this.autoCultivate,
                    upgrades: this.upgrades,
                    manor: this.manor,
                    speedBoostEnd: this.speedBoostEnd
                };
                
                localStorage.setItem('textCultivationGame', JSON.stringify(saveData));
            },
            
            // 加载游戏
            loadGame() {
                const saved = localStorage.getItem('textCultivationGame');
                
                if (saved) {
                    const saveData = JSON.parse(saved);
                    
                    this.cultivation = saveData.cultivation || 0;
                    this.spiritStones = saveData.spiritStones || 100;
                    this.realmIndex = saveData.realmIndex || 0;
                    this.cultivationSpeed = saveData.cultivationSpeed || 1;
                    this.totalCultivationTime = saveData.totalCultivationTime || 0;
                    this.autoCultivate = saveData.autoCultivate !== undefined ? saveData.autoCultivate : true;
                    this.speedBoostEnd = saveData.speedBoostEnd || 0;
                    
                    // 加载升级数据
                    if (saveData.upgrades) {
                        saveData.upgrades.forEach(savedUpgrade => {
                            const upgrade = this.upgrades.find(u => u.id === savedUpgrade.id);
                            if (upgrade) {
                                upgrade.level = savedUpgrade.level || 0;
                            }
                        });
                    }
                    
                    // 加载洞府数据
                    if (saveData.manor) {
                        saveData.manor.forEach(savedManor => {
                            const manor = this.manor.find(m => m.id === savedManor.id);
                            if (manor) {
                                manor.level = savedManor.level || 0;
                            }
                        });
                    }
                    
                    this.log("游戏存档已加载", "neutral");
                }
            },
            
            // 设置事件监听器
            setupEventListeners() {
                // 修炼按钮
                document.getElementById('cultivateBtn').addEventListener('click', () => {
                    this.cultivation += 10;
                    this.log("你进行了一次修炼，获得10点修为", "neutral");
                    this.render();
                });
                
                // 突破按钮
                document.getElementById('breakthroughBtn').addEventListener('click', () => {
                    this.breakthrough();
                });
                
                // 闭关冥想按钮
                document.getElementById('meditateBtn').addEventListener('click', () => {
                    const gain = Math.floor(Math.random() * 20) + 10;
                    this.cultivation += gain;
                    this.log(`你进行了一次闭关冥想，获得${gain}点修为`, "neutral");
                    this.render();
                });
                
                // 吸收灵气按钮
                document.getElementById('absorbSpiritBtn').addEventListener('click', () => {
                    const gain = Math.floor(Math.random() * 5) + 5;
                    this.cultivation += gain;
                    this.log(`你吸收了一次天地灵气，获得${gain}点修为`, "neutral");
                    this.render();
                });
                
                // 自动修炼切换
                document.getElementById('autoCultivateToggle').addEventListener('change', (e) => {
                    this.autoCultivate = e.target.checked;
                    this.log(`自动修炼已${this.autoCultivate ? '开启' : '关闭'}`, "neutral");
                });
                
                // 初始化自动修炼开关状态
                document.getElementById('autoCultivateToggle').checked = this.autoCultivate;
            }
        };

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', () => {
            game.init();
        });
    </script>
</body>
</html>